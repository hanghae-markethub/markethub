<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Market Hub Purchase Page</title>
    <style>
        /* 기존 스타일에 추가할 스타일 */
        .purchase-list {
            margin: 0;
            padding: 0;
            list-style-type: none;
        }
        .purchase-list li {
            cursor: pointer;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .purchase-list li:hover {
            background-color: #f0f0f0;
        }
        .container {
            width: 600px;
            margin: 20px auto;
        }
        .info-section {
            background-color: #f8f8f8;
            padding: 15px;
            margin-bottom: 10px;
        }
        /* 상세 정보 섹션을 위한 스타일 */
        .details-section {
            background-color: #e9e9e9;
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Market Hub</h1>
    <div id="purchaseList" class="info-section">
        <h2>주문 목록</h2>
        <ul class="purchase-list"></ul>
    </div>
    <div class="info-section">
        <h2>주문 상세 정보</h2>
        <div id="purchaseDetails"></div>
        <!-- 주문 상세 정보를 표시할 곳 -->
    </div>
</div>
<!-- 숨겨진 필드로 itemUid 저장 -->

<script>
    document.addEventListener('DOMContentLoaded', function() {
        fetchPurchases();
    });
    let selectedPurchaseId = null;
    let selectedPurchasePrice = 0
    let selectedImpUid = null;
    let selectedItemid = null;
    let selectedItemQunatity = null;
    function fetchPurchases() {
        const token = getCookie('Authorization');
        fetch('/api/purchase/searchAllPurchase', {
            headers: { 'Authorization': token }
        })
            .then(response => response.json())
            .then(data => {
                const listElement = document.getElementById('purchaseList').querySelector('.purchase-list');
                data.forEach(purchase => {
                    // 상태 텍스트 변환 로직 추가
                    const statusText = getStatusText(purchase.status);

                    const listItem = document.createElement('li');
                    listItem.textContent = `주문 번호: ${purchase.purchaseId}, 상품명: ${purchase.itemDetails.itemName}, 배송 상태: ${statusText}`;
                    listItem.onclick = () => fetchPurchaseDetails(purchase.purchaseId);
                    listElement.appendChild(listItem);
                    selectedPurchaseId = `${purchase.purchaseId}`; // 선택된 주문 ID 업데이트


                });
            })
            .catch(error => console.error('Error fetching purchase list:', error));
    }
    function saveItemUid(itemUid) {
        document.getElementById('hiddenItemUid').value = itemUid;
    }

    function fetchPurchaseDetails(purchaseId) {
        const token = getCookie('Authorization');
        fetch(`/api/purchase/searchPurchase/${purchaseId}`, {
            headers: { 'Authorization': token }
        })
            .then(response => response.json())
            .then(data => {
                const detailsContainer = document.getElementById('purchaseDetails');
                detailsContainer.innerHTML = ''; // 기존 내용 초기화

                const formattedPrice = new Intl.NumberFormat('ko-KR', { style: 'currency', currency: 'KRW' }).format(data.itemDetails.price);
                const statusText = getStatusText(data.status); // 상태 텍스트 변환 로직 적용
                selectedItemid = data.itemDetails.itemId;
                selectedItemQunatity = data.itemDetails.quantity;

                // 상세 정보 생성
                detailsContainer.innerHTML = `
        <p><strong>상품명:</strong> ${data.itemDetails.itemName}</p>
        <p><strong>수량:</strong> ${data.itemDetails.quantity}</p>
        <p><strong>가격:</strong> ${formattedPrice}</p>
        <p><strong>주문 상태:</strong> ${statusText}</p>
    `;

                // 주문 상태가 'CANCELLED'이 아닌 경우에만 주문 취소 버튼 생성
                if (data.status !== 'CANCELLED') {
                    const cancelButton = document.createElement('button');
                    cancelButton.textContent = '주문 취소';
                    cancelButton.onclick = function() { cancelPurchase(data.impUid); }; // 클릭 시 cancelPurchase 호출
                    detailsContainer.appendChild(cancelButton);
                }

                // 선택된 주문의 impUid 저장
                selectedImpUid = data.impUid;
                selectedPurchasePrice = data.itemDetails.price * data.itemDetails.quantity;
            })
            .catch(error => console.error('Error fetching purchase details:', error));
    }


    function cancelPurchase() {
        if (!selectedPurchaseId) return; // 선택된 주문 ID가 없으면 함수 종료

        const token = getCookie('Authorization');
        fetch(`/api/payment/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token
            },
            body: JSON.stringify({
                imp_uid: selectedImpUid,
                checksum: selectedPurchasePrice, // 여기에 저장된 가격을 사용
                reason: "고객 요청에 의한 취소",
                itemId: selectedItemid,
                quantity: selectedItemQunatity
            })
        })
            .then(response => {
                if (response.ok) {
                    alert('주문이 성공적으로 취소되었습니다.');
                    fetchPurchases(); // 주문 목록을 다시 불러옵니다.
                    location.reload();
                } else {
                    alert('주문 취소에 실패했습니다.');
                }
            })
            .catch(error => {
                console.error('Error canceling purchase:', error);
                alert('주문 취소 과정에서 오류가 발생했습니다.');
            });
    }

    // 쿠키에서 특정 이름의 쿠키 값을 가져오는 함수
    function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
    }

    // 상태 코드를 사용자 친화적인 텍스트로 변환하는 함수
    function getStatusText(status) {
        switch(status) {
            case 'IN_DELIVERY':
                return '배송중';
            case 'DELIVERY_COMPLETE':
                return '배송완료';
            case 'ORDER_COMPLETE':
                return '주문완료';
            case 'CANCELLED':
                return '주문취소'
            case 'DELETED':
                return '결제오류'
            default:
                return '상태미정'; // 알 수 없는 상태에 대한 기본 텍스트
        }
    }
</script>
</body>
</html>
